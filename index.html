<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #313338; color: #dbdee1; margin: 0; overflow: hidden; font-family: sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #2b2d31; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e1f22; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIG ---
        const SB_URL = 'https://nrpiojdaltgfgswvhrys.supabase.co';
        const SB_KEY = 'sb_publishable_nu-if7EcpRJkKD9bXM97Rg__X3ELLW7';
        
        // Using persistSession: false to bypass browser "Tracking Prevention" blocks
        const _supabase = supabase.createClient(SB_URL, SB_KEY, {
            auth: { persistSession: false }
        });

        function App() {
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState('');
            const [user, setUser] = useState({ 
                name: localStorage.getItem('chat_name') || '', 
                pfp: localStorage.getItem('chat_pfp') || `https://api.dicebear.com/7.x/bottts/svg?seed=${Math.random()}` 
            });
            const [isJoined, setIsJoined] = useState(!!user.name);
            const scrollRef = useRef();

            // 1. Fetch Messages
            const fetchMsgs = async () => {
                const { data, error } = await _supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (error) console.error("Fetch Error:", error.message);
                else setMessages(data || []);
            };

            // 2. Realtime Subscription
            useEffect(() => {
                if (!isJoined) return;
                fetchMsgs();

                const channel = _supabase.channel('global')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
                        fetchMsgs();
                    })
                    .subscribe();

                return () => _supabase.removeChannel(channel);
            }, [isJoined]);

            // 3. Auto-scroll
            useEffect(() => {
                scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // 4. Send Message
            const sendMessage = async (e) => {
                e.preventDefault();
                if (!text.trim()) return;

                const { error } = await _supabase
                    .from('messages')
                    .insert([{ 
                        display_name: user.name, 
                        pfp_url: user.pfp, 
                        content: text,
                        reactions: {}
                    }]);

                if (error) {
                    console.error("Database Error:", error);
                    alert(`Error: ${error.message}\nCheck if you ran the SQL script to refresh the cache.`);
                } else {
                    setText('');
                }
            };

            // 5. Profile Actions
            const logout = () => {
                localStorage.clear();
                window.location.reload();
            };

            const changePfp = () => {
                const url = prompt("Enter Image URL:", user.pfp);
                if (url) {
                    setUser({...user, pfp: url});
                    localStorage.setItem('chat_pfp', url);
                }
            };

            if (!isJoined) {
                return (
                    <div className="flex items-center justify-center h-screen bg-[#1e1f22]">
                        <div className="bg-[#313338] p-8 rounded-lg w-80 shadow-2xl border border-[#2b2d31]">
                            <h2 className="text-white font-bold mb-4 text-center text-xl">Join Global Chat</h2>
                            <input 
                                className="w-full p-2 mb-4 rounded bg-[#1e1f22] text-white outline-none border border-transparent focus:border-[#5865f2]" 
                                placeholder="Display Name" 
                                onChange={e => setUser({...user, name: e.target.value})} 
                            />
                            <button 
                                className="w-full bg-[#5865f2] p-2 rounded text-white font-bold hover:bg-[#4752c4] transition"
                                onClick={() => { if(user.name) { localStorage.setItem('chat_name', user.name); setIsJoined(true); } }}
                            >
                                Join
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen">
                    {/* Sidebar */}
                    <div className="w-64 bg-[#2b2d31] flex flex-col p-4 border-r border-[#1e1f22]">
                        <div className="font-bold text-white mb-4"># global-chat</div>
                        <div className="flex-1 text-xs text-gray-500 italic">Welcome! Click your PFP to change it.</div>
                        
                        <div className="mt-auto pt-4 border-t border-[#3f4147]">
                            <div className="flex items-center gap-3 mb-4">
                                <img 
                                    src={user.pfp} 
                                    onClick={changePfp}
                                    className="w-10 h-10 rounded-full cursor-pointer hover:opacity-80 transition bg-gray-600"
                                    title="Change Profile Picture"
                                />
                                <div className="truncate">
                                    <div className="text-white text-sm font-bold truncate">{user.name}</div>
                                    <div className="text-[10px] text-green-500 font-bold uppercase">Online</div>
                                </div>
                            </div>
                            <button 
                                onClick={logout}
                                className="w-full py-1.5 bg-[#4e5058] hover:bg-[#da373c] text-white rounded text-xs font-bold transition"
                            >
                                LOGOUT
                            </button>
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 flex flex-col bg-[#313338]">
                        <header className="h-12 border-b border-[#26272d] flex items-center px-4 shadow-sm">
                            <span className="font-bold text-white"># global-chat</span>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            {messages.map(msg => (
                                <div key={msg.id} className="flex gap-4 mb-4 hover:bg-[#2e3035] p-1 rounded group transition-colors">
                                    <img src={msg.pfp_url} className="w-10 h-10 rounded-full bg-gray-500 mt-1" />
                                    <div>
                                        <div className="flex gap-2 items-center">
                                            <span className="text-white font-bold">{msg.display_name}</span>
                                            <span className="text-[10px] text-gray-500 uppercase font-semibold">
                                                {new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                            </span>
                                        </div>
                                        <p className="text-[#dbdee1] leading-relaxed">{msg.content}</p>
                                    </div>
                                </div>
                            ))}
                            <div ref={scrollRef} />
                        </main>

                        <form onSubmit={sendMessage} className="p-4">
                            <input 
                                className="w-full bg-[#383a40] p-3 rounded-lg text-white outline-none focus:ring-1 focus:ring-[#5865f2] transition-all" 
                                placeholder="Message #global-chat" 
                                value={text} 
                                onChange={e => setText(e.target.value)} 
                            />
                        </form>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
