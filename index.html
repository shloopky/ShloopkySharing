<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #313338; color: #dbdee1; margin: 0; overflow: hidden; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #2b2d31; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e1f22; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURATION ---
        const SB_URL = 'https://nrpiojdaltgfgswvhrys.supabase.co';
        const SB_KEY = 'sb_publishable_nu-if7EcpRJkKD9bXM97Rg__X3ELLW7';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        
        // Change this to your secret code!
        const ADMIN_PASSWORD = 'admin123'; 

        function App() {
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState('');
            const [search, setSearch] = useState('');
            const [user, setUser] = useState({ 
                name: localStorage.getItem('chat_name') || '', 
                pfp: localStorage.getItem('chat_pfp') || `https://api.dicebear.com/7.x/identicon/svg?seed=${Math.random()}` 
            });
            const [isJoined, setIsJoined] = useState(!!user.name);
            const scrollRef = useRef();

            useEffect(() => {
                if (!isJoined) return;

                const fetchMsgs = async () => {
                    const { data } = await _supabase.from('messages').select('*').order('created_at', { ascending: true });
                    setMessages(data || []);
                    // Trigger the 5-day auto-delete function
                    await _supabase.rpc('delete_old_messages');
                };

                fetchMsgs();

                const channel = _supabase.channel('global-chat')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload => {
                        if (payload.eventType === 'INSERT') {
                            setMessages(prev => [...prev, payload.new]);
                        } else if (payload.eventType === 'DELETE') {
                            fetchMsgs(); // Refresh list if messages are cleared
                        }
                    })
                    .subscribe();

                return () => _supabase.removeChannel(channel);
            }, [isJoined]);

            useEffect(() => {
                scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!text.trim()) return;
                await _supabase.from('messages').insert([{ 
                    display_name: user.name, 
                    pfp_url: user.pfp, 
                    content: text 
                }]);
                setText('');
            };

            const clearChat = async () => {
                if(confirm("Are you sure you want to delete EVERY message?")) {
                    const { error } = await _supabase.from('messages').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                    if (error) console.error(error);
                }
            };

            const filteredMessages = messages.filter(m => 
                m.content.toLowerCase().includes(search.toLowerCase())
            );

            if (!isJoined) {
                return (
                    <div className="flex items-center justify-center h-screen bg-[#1e1f22]">
                        <div className="bg-[#313338] p-8 rounded-lg shadow-xl w-96 border border-[#2b2d31]">
                            <h1 className="text-2xl font-bold mb-6 text-white text-center">Identity Setup</h1>
                            <label className="text-xs font-bold text-gray-400 uppercase">Display Name</label>
                            <input className="w-full p-3 mt-1 mb-4 rounded bg-[#1e1f22] border-none text-white focus:outline-none" 
                                placeholder="What should we call you?" 
                                onChange={e => setUser({...user, name: e.target.value})} 
                            />
                            <label className="text-xs font-bold text-gray-400 uppercase">Profile Picture URL</label>
                            <input className="w-full p-3 mt-1 mb-6 rounded bg-[#1e1f22] border-none text-white focus:outline-none" 
                                placeholder="Link to an image (optional)" 
                                onChange={e => setUser({...user, pfp: e.target.value || user.pfp})} 
                            />
                            <button className="w-full bg-[#5865f2] hover:bg-[#4752c4] text-white p-3 rounded font-medium transition"
                                onClick={() => { if(user.name) { localStorage.setItem('chat_name', user.name); setIsJoined(true); } }}>
                                Finish Setup
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen">
                    {/* Sidebar */}
                    <div className="w-60 bg-[#2b2d31] flex-shrink-0 flex flex-col">
                        <div className="p-4 font-bold text-white border-b border-[#1e1f22] shadow-sm">Global Server</div>
                        <div className="flex-1 p-2">
                            <div className="bg-[#393c41] text-white p-2 rounded flex items-center mb-2">
                                <span className="mr-2">#</span> global-chat
                            </div>
                        </div>
                        {/* Admin Section */}
                        {search === ADMIN_PASSWORD && (
                            <div className="p-4 bg-[#202225]">
                                <button onClick={clearChat} className="w-full bg-red-500 hover:bg-red-600 text-white text-xs py-2 rounded transition font-bold">
                                    CLEAR ALL MESSAGES
                                </button>
                            </div>
                        )}
                        <div className="bg-[#232428] p-3 flex items-center">
                            <img src={user.pfp} className="w-8 h-8 rounded-full mr-2 bg-gray-500" />
                            <div className="text-sm truncate font-semibold text-white">{user.name}</div>
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 flex flex-col bg-[#313338]">
                        <header className="h-12 border-b border-[#26272d] flex items-center px-4 justify-between shadow-md">
                            <div className="flex items-center font-bold text-white">
                                <span className="text-gray-400 text-2xl mr-2">#</span> global-chat
                            </div>
                            <div className="relative">
                                <input 
                                    className="bg-[#1e1f22] text-sm p-1 px-3 rounded w-64 focus:outline-none text-white border border-transparent focus:border-[#5865f2]" 
                                    placeholder="Search or enter admin key..." 
                                    value={search}
                                    onChange={e => setSearch(e.target.value)}
                                />
                            </div>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            {filteredMessages.length === 0 && search && (
                                <div className="text-gray-500 text-center mt-10">No messages found matching "{search}"</div>
                            )}
                            {filteredMessages.map(msg => (
                                <div key={msg.id} className="flex items-start mb-4 hover:bg-[#2e3035] -mx-4 px-4 py-1 transition-colors group">
                                    <img src={msg.pfp_url} className="w-10 h-10 rounded-full mr-4 mt-1 bg-[#4f545c]" />
                                    <div>
                                        <div className="flex items-baseline">
                                            <span className="text-[#f2f3f5] font-medium mr-2 hover:underline cursor-pointer">{msg.display_name}</span>
                                            <span className="text-[10px] text-gray-400 uppercase">
                                                {new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                            </span>
                                        </div>
                                        <p className="text-[#dbdee1] whitespace-pre-wrap">{msg.content}</p>
                                    </div>
                                </div>
                            ))}
                            <div ref={scrollRef} />
                        </main>

                        <footer className="px-4 pb-6">
                            <form onSubmit={handleSendMessage} className="bg-[#383a40] rounded-lg flex items-center px-4">
                                <input 
                                    className="w-full bg-transparent py-3 text-[#dbdee1] focus:outline-none" 
                                    placeholder={`Message #global-chat`} 
                                    value={text}
                                    onChange={e => setText(e.target.value)}
                                />
                            </form>
                        </footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
